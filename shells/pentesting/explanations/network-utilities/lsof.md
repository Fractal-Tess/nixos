# LSOF - List Open Files

## Overview
LSOF (List Open Files) is a utility for:
- Finding which files are open by which processes
- Network connection analysis
- Process monitoring
- Troubleshooting file access issues
- Security auditing

## Basic Usage

### List All Open Files
```bash
# List all open files (may be extensive)
lsof

# List open files for specific user
lsof -u username

# List open files for specific process
lsof -p 1234

# List open files in specific directory
lsof /path/to/directory
```

### Network Connections
```bash
# List all network connections
lsof -i

# List IPv4 connections only
lsof -i 4

# List IPv6 connections only
lsof -i 6

# List connections for specific protocol
lsof -i TCP
lsof -i UDP
```

## Process Information

### Process-Specific Queries
```bash
# Files opened by specific PID
lsof -p 1234

# Files opened by multiple processes
lsof -p 1234,5678,9012

# Files opened by process name
lsof -c process_name

# Exclude specific processes
lsof -p ^1234
```

### User and Group Queries
```bash
# Files opened by specific user
lsof -u username

# Files opened by multiple users
lsof -u user1,user2

# Files opened by users except root
lsof -u ^root

# Files opened by specific group
lsof -g groupname
```

## Network Analysis

### Network Connection Details
```bash
# List all network connections
lsof -i

# List connections on specific port
lsof -i :80
lsof -i :443

# List connections for specific IP
lsof -i 192.168.1.100

# List connections for specific protocol
lsof -i TCP
lsof -i UDP
```

### Socket Information
```bash
# List all sockets
lsof -i -n -P

# List Unix domain sockets
lsof -U

# List NFS sockets
lsof -N

# List specific socket types
lsof -i TCP -s TCP:LISTEN
```

### Network Service Analysis
```bash
# Find processes listening on ports
lsof -i -s TCP:LISTEN

# Find processes using specific ports
lsof -i :22,80,443

# Find processes connected to specific hosts
lsof -i @192.168.1.100

# Find processes using specific protocols
lsof -i UDP
```

## File System Analysis

### Directory Monitoring
```bash
# Files open in specific directory
lsof /var/log
lsof /home
lsof /tmp

# Files open recursively
lsof +D /path/to/directory

# Files open in current directory
lsof .
```

### File Type Filtering
```bash
# Regular files only
lsof -f -- /path

# Directory files only
lsof -f -- /path | grep DIR

# Character devices
lsof -f -- /dev

# Block devices
lsof -f -- | grep BLK
```

### File Access Monitoring
```bash
# Files being written
lsof | grep -w "REG" | grep -w "U"

# Files being read
lsof | grep -w "REG" | grep -w "r"

# Files with specific permissions
lsof -u username | grep -w "w"
```

## Security Monitoring

### Suspicious Activity Detection
```bash
# Network connections by unusual processes
lsof -i | grep -E "(nc|netcat|bash|sh)"

# Processes listening on unusual ports
lsof -i -s TCP:LISTEN | grep -v -E "(:(22|80|443|53)|sshd|httpd)"

# Files opened in system directories
lsof /etc /bin /sbin /usr/bin

# Processes accessing sensitive files
lsof /etc/passwd /etc/shadow /etc/ssh/
```

### Process Monitoring
```bash
# Processes with deleted files
lsof | grep "(deleted)"

# Processes running as root
lsof -u root

# Processes with network connections
lsof -i -n -P

# Processes with open terminals
lsof /dev/tty*
```

## Practical Examples

### Port Discovery
```bash
#!/bin/bash
# Discover listening ports and processes

echo "=== Listening Ports and Processes ==="
lsof -i -s TCP:LISTEN -n -P | while read line; do
    if [[ "$line" == *LISTEN* ]]; then
        echo "$line"
    fi
done

echo ""
echo "=== UDP Ports ==="
lsof -i UDP -n -P | grep -v "UDP *:*"
```

### File Access Monitoring
```bash
#!/bin/bash
# Monitor file access in specific directory

directory="$1"

if [ -z "$directory" ]; then
    echo "Usage: $0 <directory>"
    exit 1
fi

echo "=== Files currently open in $directory ==="
lsof +D "$directory"

echo ""
echo "=== Processes accessing files in $directory ==="
lsof +d "$directory"
```

### Network Connection Monitor
```bash
#!/bin/bash
# Monitor network connections

echo "=== Established Connections ==="
lsof -i -n -P | grep ESTABLISHED

echo ""
echo "=== Listening Services ==="
lsof -i -n -P -s TCP:LISTEN

echo ""
echo "=== UDP Services ==="
lsof -i UDP -n -P | grep -v "UDP *:*"
```

### Deleted File Detection
```bash
#!/bin/bash
# Find processes using deleted files

echo "=== Processes using deleted files ==="
lsof | grep "(deleted)" | while read line; do
    pid=$(echo "$line" | awk '{print $2}')
    process=$(echo "$line" | awk '{print $1}')
    file=$(echo "$line" | awk '{print $NF}')

    echo "PID: $pid, Process: $process, Deleted file: $file"
done
```

## Advanced Usage

### Complex Queries
```bash
# Find processes with both network and file access
lsof -i -u username

# Find processes accessing files and listening on ports
lsof -i -s TCP:LISTEN +D /var/log

# Exclude certain file types
lsof -i -f -- /proc | grep -v mem

# Find processes with specific characteristics
lsof -u root -i -s TCP:LISTEN
```

### Output Formatting
```bash
# Verbose output
lsof -v

# Exclude header
lsof -F pcn

# Custom format
lsof -F pcn -i :80

# Human-readable sizes
lsof -s | grep -E "(SIZE|OFFSET)"
```

### Performance Monitoring
```bash
# Find processes using many files
for pid in $(lsof -t | sort | uniq -c | sort -nr | head -10 | awk '{print $2}'); do
    count=$(lsof -p "$pid" | wc -l)
    echo "PID $pid: $count open files"
done

# Monitor file descriptor usage
lsof -p 1 | wc -l
```

## Troubleshooting

### Common Issues
```bash
# "Device not configured" errors
# May need different options
lsof -i
lsof +D /path

# Permission denied errors
# Use sudo
sudo lsof -u root

# Output too large
# Filter results
lsof -i | grep ESTABLISHED
lsof -u username | grep REG
```

### Debugging File Access
```bash
# Who is using this file?
lsof /path/to/file

# What files does this process have open?
lsof -p 1234

# Who is accessing this directory?
lsof +D /path/to/directory

# Why can't I unmount this filesystem?
lsof /mount/point
```

## Integration with Other Tools

### Combine with ps
```bash
# Get full process information
lsof -p 1234 | awk '{print $2}' | xargs ps -fp

# Find parent processes
for pid in $(lsof -t); do
    parent=$(ps -o ppid= -p "$pid")
    echo "PID: $pid, Parent: $parent"
done
```

### Combine with netstat
```bash
# Compare network connections
echo "=== LSOF Network Connections ==="
lsof -i -n -P

echo "=== Netstat Connections ==="
netstat -tuln
```

### Combine with grep
```bash
# Filter specific file types
lsof | grep -E "(\.log|\.conf|\.pid)"

# Filter specific processes
lsof | grep -E "(httpd|mysql|sshd)"

# Filter specific users
lsof | grep -E "(root|nobody|www-data)"
```

## Tips
- Use `sudo` for system-wide information
- Filter results to reduce output
- Combine with other tools for comprehensive analysis
- Use specific options for different use cases
- Monitor deleted files for potential issues
- Use `+D` for directory traversal (recursive)
- Use `-i` for network analysis
- Be cautious with `lsof` on very busy systems
- Consider performance impact on production systems
- Use `lsof` for troubleshooting file access issues
- Regular monitoring helps detect unusual activity